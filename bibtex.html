<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BibTeX Generator</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/solar/bootstrap.min.css"
      rel="stylesheet" />

    <link rel="stylesheet" href="overrides.css" />
  </head>
  <body>

    <header class="text-center py-2">
      <h1 class="mb-1">BibTeX Citation Generator</h1>
      <p class="text-muted">
        Fill the fields → generate a <code>.bib</code> entry. Saved locally in
        your browser.
      </p>
    </header>

    <main class="container-xxl mb-3">
      <div class="row g-3">

        <!-- FORM SIDE -->
        <section class="col-lg-7">
          <div class="card p-2 form-compact">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="badge bg-secondary">BibTeX</span>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-light btn-sm"
                  id="downloadAllBtn">Download All (.bib)</button>
                <button class="btn btn-outline-danger btn-sm"
                  id="clearAllBtn">Clear Saved</button>
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6" data-field="entryType">
                <label class="form-label fw-semibold">Entry type</label>
                <select id="entryType" class="form-select">
                  <option value="online">@online</option>
                  <option value="article">@article</option>
                  <option value="book">@book</option>
                  <option value="inproceedings">@inproceedings</option>
                  <option value="misc">@misc</option>
                </select>
              </div>

              <div class="col-md-6" data-field="citeKey">
                <label class="form-label">Citation key</label>
                <input id="citeKey" class="form-control" 
                  placeholder="auto-generated if empty">
              </div>
            </div>

            <div class="row g-3">
              <div class="col-md-6" data-field="author">
                <label class="form-label">Author(s)</label>
                <input id="author" class="form-control" placeholder="Red Hat">
                <div class="form-text">Separate multiple authors with
                  <code>and</code></div>
              </div>

              <div class="col-md-6" data-field="title">
                <label class="form-label">Title</label>
                <input id="title" class="form-control" placeholder="Example Title"> 
              </div>

              <div class="col-md-4" data-field="year">
                <label class="form-label">Year</label>
                <input id="year" type="number" class="form-control" placeholder="2026">
              </div>

              <div class="col-md-4" data-field="month">
                <label class="form-label">Month</label>
                <input id="month" class="form-control">
              </div>

              <div class="col-md-4" data-field="journal">
                <label class="form-label">Journal</label>
                <input id="journal" class="form-control">
              </div>

              <div class="col-md-6" data-field="booktitle">
                <label class="form-label">Booktitle</label>
                <input id="booktitle" class="form-control">
              </div>

              <div class="col-md-6" data-field="publisher">
                <label class="form-label">Publisher</label>
                <input id="publisher" class="form-control">
              </div>

              <div class="col-md-6" data-field="url">
                <label class="form-label">URL</label>
                <input id="url" class="form-control" placeholder="example.com">
              </div>

              <div class="col-md-6" data-field="doi">
                <label class="form-label">DOI</label>
                <input id="doi" class="form-control">
              </div>

              <div class="col-12" data-field="note">
                <label class="form-label">Note</label>
                <input id="note" class="form-control">
              </div>

              <div class="row g-3 mt-1">
                <div class="col-md-6" data-field="editor">
                  <label class="form-label">Editor</label>
                  <input id="editor" class="form-control">
                </div>

                <div class="col-md-3" data-field="volume">
                  <label class="form-label">Volume</label>
                  <input id="volume" class="form-control">
                </div>

                <div class="col-md-3" data-field="number">
                  <label class="form-label">Number</label>
                  <input id="number" class="form-control">
                </div>

                <div class="col-md-6" data-field="pages">
                  <label class="form-label">Pages</label>
                  <input id="pages" class="form-control" placeholder="12--34">
                </div>

                <div class="col-md-6" data-field="address">
                  <label class="form-label">Address</label>
                  <input id="address" class="form-control">
                </div>

                <div class="col-md-6" data-field="organization">
                  <label class="form-label">Organization</label>
                  <input id="organization" class="form-control">
                </div>

                <div class="col-md-6" data-field="howpublished">
                  <label class="form-label">How published</label>
                  <input id="howpublished" class="form-control">
                </div>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 mt-3">
              <button id="genBtn" class="btn btn-primary">Generate</button>
              <button id="copyBtn" class="btn btn-secondary">Copy</button>
              <button id="downloadBtn" class="btn btn-secondary">Download
                (.bib)</button>
              <button id="saveBtn" class="btn btn-secondary">Save</button>
              <button id="resetBtn"
                class="btn btn-outline-secondary">Reset</button>
            </div>

            <div class="mt-3">
              <label class="form-label">Output</label>
              <textarea id="output" class="form-control font-monospace"
                rows="6"></textarea>
            </div>

          </div>
        </section>

        <!-- SAVED SIDE -->
        <section class="col-lg-5">
          <div class="card p-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Saved entries</h5>
              <span class="text-muted small" id="savedCount">0 items</span>
            </div>

            <div class="d-flex flex-column gap-2" id="savedList"></div>
          </div>
        </section>

      </div>
    </main>

    <template id="saved-item-template">
      <div class="card card-body p-2">
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="fw-semibold text-truncate flex-grow-1 key"></span>
          <div class="d-flex gap-1 flex-nowrap">
            <button class="btn btn-sm btn-outline-light"
              data-action="copy">Copy</button>
            <button class="btn btn-sm btn-outline-light"
              data-action="download">.bib</button>
            <button class="btn btn-sm btn-outline-secondary"
              data-action="load">Load</button>
            <button class="btn btn-sm btn-outline-danger"
              data-action="delete">Delete</button>
          </div>
        </div>
        <pre class="mb-0 small code"></pre>
      </div>
    </template>
    <footer class="mt-auto py-3">
  <div class="container-xxl text-center small text-muted">
    --<br>BibTeX Generator · https://github.com/sampozki/bibtex-generator
  </div>
</footer>

    <script>
    const el = id => document.getElementById(id);

    const REQUIRED = {
      online: ["citeKey","title","author","year","url"],
      article: ["citeKey","title","author","journal","year"],
      book: ["citeKey","title","author","publisher","year"],
      inproceedings: ["citeKey","title","author","booktitle","year"],
      misc: ["citeKey"]
    };

    const VISIBLE_FIELDS = {
      online: ["citeKey","author","title","year","month","url","doi","note"],
      article: ["citeKey","author","title","journal","year","month","volume","number","pages","doi","url","note"],
      book: ["citeKey","author","editor","title","publisher","year","month","volume","number","address","doi","url","note"],
      inproceedings: ["citeKey","author","title","booktitle","year","month","pages","organization","address","doi","url","note"],
      misc: ["citeKey","author","title","year","howpublished","url","note"]
    };

    const FIELD_IDS = [
      "citeKey","author","title","year","month","journal","booktitle","publisher","editor","volume","number","pages","address","organization","doi","url","howpublished","note"
    ];

    const LABEL_IDS = {
      citeKey: 'label-citeKey',
      author: 'label-author',
      title: 'label-title',
      year: 'label-year',
      journal: 'label-journal',
      booktitle: 'label-booktitle',
      publisher: 'label-publisher',
      url: 'label-url'
    };

    function normalizeMonth(m){
      if(!m) return "";
      const map = {jan:"Jan",feb:"Feb",mar:"Mar",apr:"Apr",may:"May",jun:"Jun",jul:"Jul",aug:"Aug",sep:"Sep",sept:"Sep",oct:"Oct",nov:"Nov",dec:"Dec"};
      const t = String(m).trim();
      if(/^[0-9]{1,2}$/.test(t)){
        const idx = Math.max(1, Math.min(12, parseInt(t,10)));
        return ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][idx];
      }
      const key = t.toLowerCase().slice(0,3);
      return map[key] || t; // fall back to user text
    }

    function updateRequiredUI(){
      const type = el('entryType').value;
      // clear all
      Object.values(LABEL_IDS).forEach(id => {
        const node = el(id);
        if (node) node.classList.remove('required');
      });
      // mark ones for current type
      (REQUIRED[type]||[]).forEach(fid => {
        const lid = LABEL_IDS[fid];
        if(lid){
          const node = el(lid);
          if (node) node.classList.add('required');
        }
      });

      updateVisibleFields(type);
    }

    const FIELD_NODES = new Map();

    function cacheFieldNodes(){
      FIELD_IDS.forEach(fid => {
        const input = el(fid);
        const container = input?.closest('[data-field]');
        if (!container) return;
        FIELD_NODES.set(fid, {
          container,
          parent: container.parentElement,
          nextSibling: container.nextElementSibling
        });
      });
    }

    function updateVisibleFields(type){
      const visible = new Set((VISIBLE_FIELDS[type] || FIELD_IDS));
      FIELD_IDS.forEach(fid => {
        const meta = FIELD_NODES.get(fid);
        if (!meta) return;
        const { container, parent, nextSibling } = meta;
        const shouldShow = visible.has(fid);
        const isInDom = container.isConnected;
        if (shouldShow && !isInDom) {
          if (nextSibling && nextSibling.parentElement === parent) {
            parent.insertBefore(container, nextSibling);
          } else {
            parent.appendChild(container);
          }
        } else if (!shouldShow && isInDom) {
          const input = el(fid);
          if (input) input.value = '';
          container.remove();
        }
      });
    }
	
	  function currentYear(){
    return String(new Date().getFullYear());
  }

  function defaultFor(field, type){
    const defaults = {
      author: 'Unknown',
      title: 'Untitled',
      year: currentYear(),
      url: 'https://example.com',
      journal: 'Unknown journal',
      publisher: 'Unknown publisher',
      booktitle: 'Unknown proceedings'
    };
    return defaults[field] || '';
  }

  function generateCiteKey({ author, title, year }){
    const clean = s =>
      s.toLowerCase()
       .replace(/[^a-z0-9\s]/g, '')
       .trim();

    const firstAuthor =
      clean(author || 'unknown')
        .split(/\s+|,/)[0] || 'unknown';

    const titleWord =
      clean(title || 'untitled')
        .split(/\s+/)
        .find(w => w.length > 3) || 'work';

    return `${firstAuthor}-${year || currentYear()}-${titleWord}`;
  }

function buildEntry(){
  const type = el('entryType').value;

  const values = Object.fromEntries(
    FIELD_IDS.map(fid => [fid, (el(fid)?.value || '').trim()])
  );

  // Normalize month
  values.month = normalizeMonth(values.month);

  // Apply defaults for required fields
  (REQUIRED[type] || []).forEach(fid => {
    if (!values[fid]) {
      values[fid] = defaultFor(fid, type);
    }
  });

  // Auto-generate citation key if missing
  if (!values.citeKey) {
    values.citeKey = generateCiteKey(values);
  }

  const fieldOrder = [
    ['author','author'],['editor','editor'],['title','title'],
    ['journal','journal'],['booktitle','booktitle'],
    ['publisher','publisher'],['organization','organization'],
    ['address','address'],['volume','volume'],['number','number'],
    ['pages','pages'],['year','year'],['month','month'],
    ['doi','doi'],['url','url'],['howpublished','howpublished'],['note','note']
  ];

  const lines = [];
  for (const [key,label] of fieldOrder){
    const v = values[key];
    if (v) lines.push(`\t${label}={${v}}`);
  }

  const inner = lines
    .map((ln,i) => i < lines.length - 1 ? ln + ',' : ln)
    .join('\n');

  return `@${type}{\n\t${values.citeKey},\n${inner}\n}`;
}

    function copyToClipboard(text){
      navigator.clipboard.writeText(text).then(()=>{
        toast('Copied to clipboard');
      }).catch(()=>{
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); toast('Copied'); }catch(e){ alert('Copy failed'); }
        document.body.removeChild(ta);
      });
    }

    function download(filename, content){
      const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    const STORAGE_KEY = 'bibgen_entries_v1';

    function loadSaved(){
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch { return []; }
    }

    function saveAll(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      renderSaved();
    }

    function saveCurrent(){
      const entry = el('output').value.trim();
      if(!entry){ alert('Nothing to save. Generate first.'); return; }
      const keyMatch = entry.match(/^@\w+\{\s*([^,\n]+)\s*,/);
      const key = keyMatch ? keyMatch[1] : `entry-${Date.now()}`;
      const items = loadSaved();
      items.unshift({ key, entry, createdAt: Date.now() });
      saveAll(items);
      toast('Saved to browser');
    }

    function renderSaved(){
      const list = el('savedList');
      list.innerHTML = '';
      const items = loadSaved();
      el('savedCount').textContent = `${items.length} item${items.length!==1?'s':''}`;
      const tpl = el('saved-item-template');
      if (!tpl) return;
      items.forEach((it, idx)=>{
        const node = tpl.content.cloneNode(true);
        node.querySelector('.key').textContent = it.key;
        node.querySelector('.code').textContent = it.entry;
        node.querySelector('[data-action="copy"]').addEventListener('click',()=>copyToClipboard(it.entry));
        node.querySelector('[data-action="download"]').addEventListener('click',()=>download(`${it.key}.bib`, it.entry+"\n"));
        node.querySelector('[data-action="load"]').addEventListener('click',()=>{ el('output').value = it.entry; toast('Loaded into editor'); });
        node.querySelector('[data-action="delete"]').addEventListener('click',()=>{
          const next = loadSaved(); next.splice(idx,1); saveAll(next); toast('Deleted');
        });
        list.appendChild(node);
      });
    }

    function downloadAll(){
      const items = loadSaved();
      if(!items.length){ alert('No saved entries.'); return; }
      const content = items.map(it=>it.entry).join('\n\n') + '\n';
      download('references.bib', content);
    }

    function clearFormFields(){
      FIELD_IDS.forEach(fid => el(fid).value = '');
    }

    function resetForm(){
      clearFormFields();
      el('entryType').value = 'online';
      updateRequiredUI();
    }

    function toast(msg){
      const n = document.createElement('div');
      n.textContent = msg;
      n.style.position='fixed'; n.style.bottom='18px'; n.style.left='50%'; n.style.transform='translateX(-50%)';
      n.style.background='#0f1530'; n.style.border='1px solid #2a3a73'; n.style.padding='10px 14px'; n.style.borderRadius='12px';
      n.style.boxShadow='0 8px 30px rgba(0,0,0,.4)'; n.style.zIndex=9999; n.style.opacity='0.97';
      document.body.appendChild(n); setTimeout(()=>{ n.remove(); }, 1600);
    }

    // Hook up buttons
    el('genBtn').addEventListener('click', ()=>{ el('output').value = buildEntry(); });
    el('copyBtn').addEventListener('click', ()=>{
      const out = el('output').value.trim();
      if(!out) { alert('Nothing to copy. Generate first.'); return; }
      copyToClipboard(out);
    });
    el('downloadBtn').addEventListener('click', ()=>{
      const out = el('output').value.trim();
      if(!out){ alert('Nothing to download. Generate first.'); return; }
      const key = (out.match(/^@\w+\{\s*([^,\n]+)\s*,/)||[])[1]||'entry';
      download(`${key}.bib`, out+"\n");
    });
    el('saveBtn').addEventListener('click', saveCurrent);
    el('resetBtn').addEventListener('click', resetForm);
    el('downloadAllBtn').addEventListener('click', downloadAll);
    el('clearAllBtn').addEventListener('click', ()=>{
      if(confirm('Delete all saved entries?')){ localStorage.removeItem(STORAGE_KEY); renderSaved(); }
    });

    el('entryType').addEventListener('change', updateRequiredUI);

    document.addEventListener('DOMContentLoaded', () => {
      clearFormFields();
      cacheFieldNodes();
      renderSaved();
      updateRequiredUI();
    });
  </script>
  </body>
</html>
